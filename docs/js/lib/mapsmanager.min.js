/*!
 * Maps Manager v1.0.0 (https://github.com/openmania/mapsmanager/)
 * 2015-07-15
 * Copyright (c) 2009-2015 Maxim Andrukhovych
 * Licensed under MIT (https://github.com/openmania/mapsmanager/blob/master/LICENSE)
 */

+function(a){"use strict";var b=[];a.mapsManager&&console.log("Namespace mapsManager already in use"),a.mapsManager={mapOptions:{center:"54.79257, -4.25293",zoom:6},prepareMapOptions:function(b,c){var d,e,f,g,h,i,j={};for(var k in c){if(d=c[k][0],e=b[d],h=a.type(e),i=c[k][1],g=a.type(i),"undefined"!=h&&"string"==g)switch(i){case"string":j[k]=e.toString();break;case"number":f=e/1,isNaN(f)||(j[k]=f);break;case"asis":j[k]=e}else"undefined"!=h&&"function"==g&&(f=i(e),"undefined"!=a.type(f)&&(j[k]=f));"undefined"==a.type(j[d])&&c[k][2]&&(j[k]=c[k][2])}return j},parsePoint:function(b){var c;try{c=a.parseJSON("["+b+"]")}catch(d){console.log("Error parsing map center: "),console.log(d)}return a.isArray(c)&&2==c.length&&"number"==a.type(c[0])&&"number"==a.type(c[1])||(console.log("Error parsing coordinate option: "),console.log("Please set coordinate correctly, for details see documentation.")),c},createCanvas:function(b){return a("<div></div>").css({width:"100%",height:"100%"}).appendTo(b)},boundsZoomLevel:function(a,b){var c=this,d=c.pixelsZoom(a.width(),b.ne.lng-b.sw.lng),e=c.pixelsZoom(a.height(),b.ne.lat-b.sw.lat);return Math.min(d,e)},pixelsZoom:function(a,b){var c=256;return 0>b&&(b+=360),Math.round(Math.log(360*a/b/c)/Math.LN2)},makePlugin:function(c,d,e){function f(b,d){return this.each(function(){var f=a(this),g=f.data("mapsmanager."+c),h="object"==typeof b&&b;g||f.data("mapsmanager."+c,g=new e(this,h)),"string"==typeof b&&g[b](d)})}for(var g in d)e.prototype[g]=d[g];"string"==typeof e.DEFAULTS.mapIcon&&b.push({name:c,plugin:f,classObject:e});var h=a.fn[c];a.fn[c]=f,a.fn[c].Constructor=e,a.fn[c].noConflict=function(){return a.fn[c]=h,this},"mapsmanager"==c&&a(window).on("load.geo.mapsmanager.data-api",function(){a("[data-mapsmanager]").each(function(){var b=a(this);f.call(b,b.data())})})},registredMaps:function(){return b},registredMapsNames:function(){for(var a=[],c=0;c<b.length;c++)a.push(b[c].name);return a}}}(jQuery),+function(a){"use strict";function b(c,d){var e=this;e.$mapElement=a(c),e.$canvas=a.mapsManager.createCanvas(c),e.canvas=e.$canvas.get(0),e.options=a.extend({},a.mapsManager.mapOptions,b.DEFAULTS,d),e.map=null,e.$map=null,e.allMarkers={},e.freeMarkers=[],e.mapMarkers=[],e.options.autoSetup&&e.setupMap()}b.VERSION="0.0.1",b.DEFAULTS={mapIcon:"/i/bingmap35.png",autoSetup:!0};var c={loadScript:function(){var b=a.Deferred();a.isArray(window.bingMaps)||(window.bingMaps=[]),window.bingMaps.push(a.proxy(b.resolve,b));var c=a("#bing-script");return 0===c.length&&(window.bingMapsInit=function(){for(var a=0;a<window.bingMaps.length;a++)window.bingMaps[a]();window.bingMaps=[]},c=a("<script></script>").attr("id","bing-script").attr("charset","UTF-8").attr("src","http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0&mkt=en-US,ngt&onScriptLoad=bingMapsInit"),a("body").append(c)),b.promise()},setupMap:function(){var b,c=this,d=a.Deferred(),e=function(){c.createMap(),b=Microsoft.Maps.Events.addHandler(c.map,"viewchangeend",function(){Microsoft.Maps.Events.removeHandler(b),d.resolve(),c.setupEvents()})};try{e()}catch(f){c.loadScript().done(e)}return d.promise()},createMap:function(){var b=this,c={credentials:["bingmapkey","string"],zoom:["zoom","number"],center:["center",function(b){var c=a.mapsManager.parsePoint(b);return new Microsoft.Maps.Location(c[0],c[1])}]},d=a.mapsManager.prepareMapOptions(b.options,c);b.map=new Microsoft.Maps.Map(b.canvas,d),b.$map=a(b)},setupEvents:function(){this.bindEvents("viewchangeend","map.boundschange")},bindEvents:function(a,b){var c=this;Microsoft.Maps.Events.addHandler(c.map,a,function(){c.$map.trigger(b)})},getZoom:function(){return this.map.getZoom()},getBounds:function(){var b=this.map.getBounds();return a.extend({},a.fn.mapsmanager.Constructor.BOUNDS,{sw:{lat:b.getSouth(),lng:b.getWest()},ne:{lat:b.getNorth(),lng:b.getEast()}})},getCenterZoom:function(){var a=this,b=a.map.getCenter();return{lat:b.latitude,lng:b.longitude,zoom:a.map.getZoom()}},setCenterZoom:function(a){var b=this;b.map.setView({center:new Microsoft.Maps.Location(a.lat,a.lng),zoom:a.zoom})},getMarker:function(a){var b=this,c=b.freeMarkers.length>0?b.freeMarkers.shift():new Microsoft.Maps.Pushpin,d=b.$mapElement.data("mapsmanager.mapsmanager").markerIcons;return c.setLocation(new Microsoft.Maps.Location(a.lat,a.lng)),c.setOptions({draggable:!1,icon:a.icon,visible:!0,width:d[a.icon].width,height:d[a.icon].height}),b.map.entities.push(c),c},hideMarker:function(a){this.map.entities.remove(a)}};a.mapsManager.makePlugin("bingmap",c,b)}(jQuery),+function(a){"use strict";function b(c,d){var e=this;e.$mapElement=a(c),e.$canvas=a.mapsManager.createCanvas(c),e.canvas=e.$canvas.get(0),e.options=a.extend({},a.mapsManager.mapOptions,b.DEFAULTS,d),e.map=null,e.$map=null,e.allMarkers={},e.freeMarkers=[],e.mapMarkers=[],e.options.autoSetup&&e.setupMap()}b.VERSION="0.0.1",b.DEFAULTS={mapIcon:"/i/googlemap35.png",autoSetup:!0};var c={loadScript:function(){var b=a.Deferred();a.isArray(window.googleMaps)||(window.googleMaps=[]),window.googleMaps.push(a.proxy(b.resolve,b));var c=a("#google-script");if(0===c.length){window.googleMapsInit=function(){for(var a=0;a<window.googleMaps.length;a++)window.googleMaps[a]();window.googleMaps=[]};var d=this.options.googlemapkey;c=a("<script></script>").attr("id","google-script").attr("src","http://maps.googleapis.com/maps/api/js?v=3.19&sensor=false&callback=googleMapsInit&language=en"+(d?"&key="+d:"")),a("body").append(c)}return b.promise()},setupMap:function(){var b=this,c=a.Deferred(),d=function(){b.createMap(),b.setupEvents(),google.maps.event.addListenerOnce(b.map,"idle",a.proxy(c.resolve,c))};try{d()}catch(e){b.loadScript().done(d)}return c.promise()},createMap:function(){var b=this,c={zoom:["zoom","number"],center:["center",function(b){var c=a.mapsManager.parsePoint(b);return new google.maps.LatLng(c[0],c[1])}]},d=a.mapsManager.prepareMapOptions(b.options,c);b.map=new google.maps.Map(b.canvas,d),b.$map=a(b)},setupEvents:function(){this.bindEvents("idle","map.boundschange"),this.bindEvents("zoom_changed","map.changezoom")},bindEvents:function(a,b){var c=this;google.maps.event.addListener(c.map,a,function(){c.$map.trigger(b)})},getZoom:function(){return this.map.getZoom()},getBounds:function(b){var c=b||this.map.getBounds(),d=c.getSouthWest(),e=c.getNorthEast();return a.extend({},a.fn.mapsmanager.Constructor.BOUNDS,{sw:{lat:d.lat(),lng:d.lng()},ne:{lat:e.lat(),lng:e.lng()}})},getCenterZoom:function(){var a=this,b=a.map.getCenter();return{lat:b.lat(),lng:b.lng(),zoom:a.map.getZoom()}},setCenterZoom:function(a){var b=this;b.map.setZoom(a.zoom),b.map.setCenter({lat:a.lat,lng:a.lng}),b.$map.trigger("map.boundschange")},getMarker:function(a){var b=this,c=b.freeMarkers.length>0?b.freeMarkers.shift():new google.maps.Marker;return c.setOptions({clickable:!1,icon:a.icon,position:new google.maps.LatLng(a.lat,a.lng),visible:!0,map:b.map}),c},hideMarker:function(a){a.setMap(null)}};a.mapsManager.makePlugin("googlemap",c,b)}(jQuery),+function(a){"use strict";function b(c,d){var e=this;e.$mapElement=a(c),e.$canvas=a.mapsManager.createCanvas(c),e.canvas=e.$canvas.get(0),e.options=a.extend({},a.mapsManager.mapOptions,b.DEFAULTS,d),e.map=null,e.$map=null,e.mapboxUrl="http://api.tiles.mapbox.com/v4/{mapid}/{z}/{x}/{y}.png?access_token={token}",e.baseLayers={},e.allLayers=[["Streets","streets-basic"],["Hybrid","streets-satellite"],["Satellite","satellite"],["Cycling","run-bike-hike"],["Outdoors","outdoors"],["Light","light"],["Dark","dark"],["Contrast","high-contrast"],["Pencil","pencil"],["Emerald","emerald"],["Pirates","pirates"],["Comic","comic"],["Wheatpaste","wheatpaste"]],e.allMarkers={},e.freeMarkers=[],e.mapMarkers=[],e.options.autoSetup&&e.setupMap()}b.VERSION="0.0.1",b.DEFAULTS={mapIcon:"/i/mapbox35.png",autoSetup:!0};var c={loadScript:function(){var b=this,c=a.Deferred();if(a.isArray(window.leafLetMaps)||(window.leafLetMaps=[]),window.leafLetMaps.push(a.proxy(c.resolve,c)),b.leafletScript=b.leafletScript||!1,b.leafletScript===!1){b.leafletScript=!0,window.leafLetMapsInit=function(){for(var a=0;a<window.leafLetMaps.length;a++)window.leafLetMaps[a]();window.leafLetMaps=[]};var d=a("<link>").attr("rel","stylesheet").attr("href","https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.css");a("head").append(d),a.getScript("https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.js",window.leafLetMapsInit)}return c.promise()},setupMap:function(){var b=this,c=a.Deferred(),d=function(){b.createMap(),b.setupEvents(),c.resolve()};try{d()}catch(e){b.loadScript().done(d)}return c.promise()},createMap:function(){var b=this,c={accessToken:["mapboxkey","string"],zoom:["zoom","number"],center:["center",function(b){var c=a.mapsManager.parsePoint(b);return L.latLng(c[0],c[1])}],layers:["mapboxkey",function(a){for(var c,d=0;d<b.allLayers.length;d++)c=b.allLayers[d],b.baseLayers[c[0]]=L.tileLayer(b.mapboxUrl,{mapid:"mapbox."+c[1],token:a});return b.baseLayers[b.allLayers[0][0]]}]},d=a.mapsManager.prepareMapOptions(b.options,c);b.map=L.mapbox.map(b.canvas,b.options.mapboxmapid||"mapbox.streets",d),b.$map=a(b),L.control.layers(b.baseLayers).addTo(b.map)},setupEvents:function(){var a=this;a.bindEvents("moveend","map.boundschange"),a.bindEvents("resize","map.boundschange"),a.bindEvents("zoomend","map.changezoom")},bindEvents:function(a,b){var c=this;c.map.on(a,function(){c.$map.trigger(b)})},getZoom:function(){return this.map.getZoom()},getBounds:function(){var b=this.map.getBounds(),c=b.getSouthWest(),d=b.getNorthEast();return a.extend({},a.fn.mapsmanager.Constructor.BOUNDS,{sw:{lat:c.lat,lng:c.lng},ne:{lat:d.lat,lng:d.lng}})},getCenterZoom:function(){var a=this,b=a.map.getCenter();return{lat:b.lat,lng:b.lng,zoom:a.map.getZoom()}},setCenterZoom:function(a){var b=this;b.map.setView([a.lat,a.lng],a.zoom)},getMarker:function(a){var b=this,c=b.freeMarkers.length>0?b.freeMarkers.shift():L.marker([a.lat,a.lng],{draggable:!1,clickable:!1,keyboard:!1}),d=b.$mapElement.data("mapsmanager.mapsmanager").markerIcons;return c.setLatLng([a.lat,a.lng]).setIcon(L.icon({iconUrl:a.icon,iconSize:[d[a.icon].width,d[a.icon].height]})).addTo(b.map),c},hideMarker:function(a){this.map.removeLayer(a)}};a.mapsManager.makePlugin("mapbox",c,b)}(jQuery),+function(a){"use strict";function b(c,d){var e=this;e.$mapElement=a(c),e.$canvas=a.mapsManager.createCanvas(c),e.canvas=e.$canvas.get(0),e.options=a.extend({},a.mapsManager.mapOptions,b.DEFAULTS,d),e.map=null,e.$map=null,e.allMarkers={},e.freeMarkers=[],e.mapMarkers=[],e.options.autoSetup&&e.setupMap()}b.VERSION="0.0.1",b.DEFAULTS={mapIcon:"/i/mapquest35.png",autoSetup:!0};var c={loadScript:function(){var b=this,c=a.Deferred();if(a.isArray(window.mapQuestMaps)||(window.mapQuestMaps=[]),window.mapQuestMaps.push(a.proxy(c.resolve,c)),b.mapQuestScript=b.mapQuestScript||!1,b.mapQuestScript===!1){b.mapQuestScript=!0,window.mapQuestMapsInit=function(){for(var a=0;a<window.mapQuestMaps.length;a++)window.mapQuestMaps[a]();window.mapQuestMaps=[]};var d=b.$mapElement.data("mapquestkey");a.getScript("http://open.mapquestapi.com/sdk/js/v7.2.s/mqa.toolkit.js?key="+d,window.mapQuestMapsInit)}return c.promise()},setupMap:function(){var b,c=this,d=a.Deferred(),e=function(){c.createMap(),b=MQA.EventManager.addListener(c.map,"zoomend",function(){MQA.EventManager.removeListener(c.map,"zoomend",b,c),c.setupEvents(),d.resolve()}),c.options.bounds&&c.map.zoomToRect(c.options.bounds,!1,MQA.MINZOOM,MQA.MAXZOOM)};try{e()}catch(f){c.loadScript().done(e)}return d.promise()},createMap:function(){var b=this,c={elt:["canvas","asis"],zoom:["zoom","number",MQA.MINZOOM],latLng:["center",function(b){var c=a.mapsManager.parsePoint(b);return{lat:c[0],lng:c[1]}}]},d=a.mapsManager.prepareMapOptions(b.options,c);b.map=new MQA.TileMap(d),b.$map=a(b),MQA.withModule("largezoom","viewoptions","geolocationcontrol","insetmapcontrol","mousewheel",function(){b.map.addControl(new MQA.LargeZoom,new MQA.MapCornerPlacement(MQA.MapCorner.TOP_LEFT,new MQA.Size(5,5))),b.map.addControl(new MQA.ViewOptions),b.map.addControl(new MQA.GeolocationControl,new MQA.MapCornerPlacement(MQA.MapCorner.TOP_RIGHT,new MQA.Size(10,50))),b.map.addControl(new MQA.InsetMapControl({size:{width:150,height:125},zoom:3,mapType:"map",minimized:!0}),new MQA.MapCornerPlacement(MQA.MapCorner.BOTTOM_RIGHT)),b.map.enableMouseWheelZoom()})},setupEvents:function(){this.bindEvents("zoomend","map.zoomchange"),this.bindEvents("moveend","map.boundschange")},bindEvents:function(a,b){var c=this;MQA.EventManager.addListener(c.map,a,function(){c.$map.trigger(b)})},getZoom:function(){return this.map.getZoomLevel()},getBounds:function(){var b=this.map.getBounds(0,0);return a.extend({},a.fn.mapsmanager.Constructor.BOUNDS,{sw:{lat:b.lr.getLatitude(),lng:b.ul.getLongitude()},ne:{lat:b.ul.getLatitude(),lng:b.lr.getLongitude()}})},getCenterZoom:function(){var a=this,b=a.map.getCenter();return{lat:b.getLatitude(),lng:b.getLongitude(),zoom:a.map.getZoomLevel()}},setCenterZoom:function(a){var b=this;b.map.setCenter({lat:a.lat,lng:a.lng},a.zoom)},getMarker:function(a){var b=this,c=b.freeMarkers,d=b.$mapElement.data("mapsmanager.mapsmanager").markerIcons,e=c.length>0?c.shift():new MQA.Poi({lat:a.lat,lng:a.lng});return e.setIcon(new MQA.Icon(a.icon,d[a.icon].width,d[a.icon].height)),e.setValues({draggable:!1,visible:!0,latLng:new MQA.LatLng(a.lat,a.lng),minZoomLevel:MQA.MINZOOM,maxZoomLevel:MQA.MAXZOOM}),b.map.addShape(e),e},hideMarker:function(a){this.map.removeShape(a)}};a.mapsManager.makePlugin("mapquest",c,b)}(jQuery),+function(a){"use strict";function b(c,d){var e=this;e.initialElement=c,e.initialOptions=a.extend({},a.mapsManager.mapOptions,b.DEFAULTS,d),e.$mapElement=a(c),e.buttons=[],e.maps=[],e.currentMap=null,e.mapsRegistry=e.managerMaps(),e.$canvas=null,e.canvas=null,e.options=null,e.map=null,e.$map=null,e.allMarkers=null,e.freeMarkers=null,e.mapMarkers=null,e.initialOptions.autoSetup&&e.setupMap()}b.VERSION="0.0.1",b.DEFAULTS={autoSetup:!0};var c={managerMaps:function(){var b=this,c=b.initialOptions.maps||"",d=a.mapsManager.registredMaps(),e=[];if(!c)return d;c=c.replace(/\s+/gi,"").split(",");var f,g;for(f=0;f<c.length;f++)for(g=0;g<d.length;g++)if(d[g].name==c[f]){e.push(d[g]);break}return e},setupMap:function(){function b(){function b(){c&&d&&(l.html("&#187;"),m=!1)}if(clearTimeout(g),m||e())return!1;m=!0;var c=!1,d=!1;j.animate({width:a(i.buttons[0]).outerWidth(!0)+l.outerWidth(!0)+3+"px"},{queue:!1,complete:function(){c=!0,b()}}),k.animate({scrollLeft:a(h).position().left+"px"},{queue:!1,complete:function(){d=!0,b()}})}function c(){return clearTimeout(g),m||!e()?!1:(j.animate({width:i.buttons.length*a(i.buttons[0]).outerWidth(!0)+l.outerWidth(!0)+3+"px"},"easeOutBack",function(){l.html("&#171;")}),!0)}function d(){var a=this;e()?c():(g=setTimeout(b,500),h!=a&&i.changeMap(h=a))}function e(){return j.width()==a(i.buttons[0]).outerWidth(!0)+l.outerWidth(!0)+3}for(var f,g,h,i=this,j=a("<div></div>").css({"background-color":"#fff",position:"absolute","z-index":999999,top:"100%",left:"10px",transform:"translate(0, -81px)",width:"56px",height:"41px","border-radius":"6px"}).appendTo(i.$mapElement),k=a("<div></div>").css({width:"100%",height:"100%","white-space":"nowrap",overflow:"hidden","border-radius":"6px"}).appendTo(j),l=a("<div>&#187;</div>").css({"background-color":"#fff",color:"#000",position:"absolute","z-index":5,"line-height":"41px","font-weight":"bold","font-size":"18px","text-align":"center",top:0,left:"100%",transform:"translate(-100%, 0)",width:"15px",height:"100%","border-top-right-radius":"6px","border-bottom-right-radius":"6px"}).appendTo(j),m=!1,n=i.mapsRegistry,o=0;o<n.length;o++)f=n[o],i.buttons.push(a("<img>").attr({alt:"",src:f.classObject.DEFAULTS.mapIcon}).css({border:"none","border-radius":"6px",margin:"3px","margin-right":o===n.length-1?l.outerWidth(!0)+3+"px":0,width:"35px",height:"35px",cursor:"pointer"}).click(d).appendTo(k).get(0));return h=i.buttons[0],j.on("mouseover",c),j.on("mouseout",function(){return m?!1:void(g=setTimeout(b,500))}),i.changeMap(h)},changeMap:function(b){function c(b){d.changeTheRest(),f&&d.maps[d.currentMap].setCenterZoom(f),b===!0&&d.showMap(),d.changingMap=!1,a(d).trigger("mapmanager.mapchange"),e.resolve()}var d=this,e=a.Deferred();d.changingMap=!0;var f,g=d.buttons.indexOf(b);if(d.currentMap==g)return e.resolve(),e.promise();if(d.maps[d.currentMap]&&(d.maps[d.currentMap].map&&(f=d.maps[d.currentMap].getCenterZoom()),d.hideMap()),d.currentMap=g,d.maps[d.currentMap])c(!0);else{var h=d.mapsRegistry[d.currentMap].name;d.$mapElement[h](a.extend({},d.initialOptions,{autoSetup:!1})),d.maps[d.currentMap]=d.$mapElement.data("mapsmanager."+h);var i=d.maps[d.currentMap];i.setupMap().then(function(){d.bindEvent(i,"map.boundschange"),d.bindEvent(i,"map.zoomchange"),c()})}return e.promise()},changeTheRest:function(){var a=this,b=a.maps[a.currentMap];a.$canvas=b.$canvas,a.canvas=b.canvas,a.options=b.options,a.map=b.map,a.$map=b.$map,a.allMarkers=b.allMarkers,a.freeMarkers=b.freeMarkers,a.mapMarkers=b.mapMarkers},bindEvent:function(b,c){var d=this,e=a(d),f=a(b);f.on(c,function(){d.currentMap!=d.maps.indexOf(b)||d.changingMap||e.trigger(c)})},hideMap:function(){this.maps[this.currentMap].$canvas.hide()},showMap:function(){this.$canvas.show()},getZoom:function(){return this.maps[this.currentMap].getZoom()},getBounds:function(){return this.maps[this.currentMap].getBounds()},showMarker:function(a){return this.maps[this.currentMap].showMarker(a)},hideMarker:function(a){return this.maps[this.currentMap].hideMarker(a)},getMarker:function(a){return this.maps[this.currentMap].getMarker(a)}};a.mapsManager.makePlugin("manager",c,b)}(jQuery),+function(a){"use strict";function b(c,d){var e=this;e.$mapElement=a(c),e.options=a.extend({},a.mapsManager.mapOptions,b.DEFAULTS,d),e.map=null,e.$map=null,e.markerReference={},e.allMarkers=[],e.hiddenMarkers=[],e.showenMarkers=[],e.levelShowen=[],e.currentMarkers=[],e.zoom=null,e.markersFeed=e.options.feed||null,e.discoveredAreas=[],e.markerSpace=e.options.space||1,e.mapRows=0,e.mapCols=0,e.markerIcons={},e.maxIconWidth=0,e.maxIconHeight=0,e.latPixel=0,e.lngPixel=0,e.setupMap()}b.VERSION="0.0.1",b.DEFAULTS={"marker-icon":"/i/defaultIcon.png"},b.POINT={lat:0,lng:0,toString:function(){return this.lat.toFixed(6)+","+this.lng.toFixed(6)}},b.MARKER=a.extend({icon:null},b.POINT),b.BOUNDS={sw:a.extend({},b.POINT),ne:a.extend({},b.POINT),toString:function(){return this.sw.toString()+","+this.ne.toString()}};var c={setupMap:function(){var b=this,c=a.Deferred(),d=b.options.mapsmanager,e=a.mapsManager.registredMapsNames(),f=-1==e.indexOf(d)?"manager":d;b.$mapElement.css({position:"relative"}),b.$mapElement[f](a.extend({},b.options,{autoSetup:!1})),b.map=b.$mapElement.data("mapsmanager."+f),b.$map=a(b.map);var g=function(){b.changeZoom(),c.resolve()};return b.map.setupMap().then(function(){b.setupEvents(),b.options.feedonce?b.loadMarkersUrl(b.options.feedonce).done(g):g()}),c.promise()},setupEvents:function(){var a=this,b=a.$map;b.on("map.boundschange",a.mapEvent(function(){a.changeZoom()||a.canvasChange()})),b.on("map.zoomchange",a.mapEvent(a.changeZoom)),b.on("mapmanager.mapchange",a.mapEvent(a.syncMarkers))},mapEvent:function(b){var c=this;return function(){c.loadMarkers().done(a.proxy(b,c))}},refresh:function(){var a=this;return a.cleanMarkers(),a.showMarkers(),!0},cleanMarkers:function(){var a,b,c,d=this,e=d.map.getBounds(),f=d.levelShowen[d.zoom];for(a=0;a<d.currentMarkers.length;a++)b=d.currentMarkers[a],c=-1==f.indexOf(b),c&&d.markerConflict(b,f)||!d.markerResidesArea(b,e)?d.hideMarker(b)&&a--:c&&d.showMarker(b)},showMarkers:function(){for(var b,c=this,d=c.levelShowen,e=c.showenMarkers,f=c.hiddenMarkers,g=c.zoom,h=0;h<c.mapRows;h++)for(var i=0;i<c.mapCols;i++)b=c.cellBounds(h,i),a.isArray(d[g])&&d[g].length>0&&c.selectMarker(b,d[g])||e.length>0&&c.selectMarker(b,e)||f.length>0&&c.selectMarker(b,f)},canvasChange:function(){return this.calculateColsRows(),this.refresh()},calculateColsRows:function(){var a=this,b=a.canvasSize(),c=a.maxIconWidth,d=a.maxIconHeight;a.mapCols=c?Math.ceil(b.width/c):0,a.mapRows=d?Math.ceil(b.height/d):0},canvasSize:function(){var a=this.map.$canvas;return{width:a.width(),height:a.height()}},changeZoom:function(){var a=this,b=a.map.getZoom();return b==a.zoom?!1:(a.setGradsPixelRatio(),a.zoom=b,null==a.levelShowen[b]&&(a.levelShowen[b]=[]),a.refresh())},setGradsPixelRatio:function(){var a=this,b=a.canvasSize(),c=a.map.getBounds();a.latPixel=(c.ne.lat-c.sw.lat)/b.height,a.lngPixel=(c.ne.lng-c.sw.lng)/b.width},loadIcon:function(b){var c=this,d=a.Deferred();if(c.markerIcons[b])return d.resolve(),d.promise();var e=new Image,f=a(e);return c.markerIcons[b]=e,f.one("load",function(){var a=e.width,b=e.height;c.maxIconWidth<a&&(c.maxIconWidth=a),c.maxIconHeight<b&&(c.maxIconHeight=b),d.resolve()}).one("error",function(){console.log("Couldn't load "+b),d.reject()}),e.src=b,d.promise()},cellBounds:function(c,d){var e=this,f=e.map.getBounds(),g=e.markerSize(),h=g.width,i=g.height;return a.extend({},b.BOUNDS,{sw:{lat:f.sw.lat+i*c,lng:f.sw.lng+h*d},ne:{lat:e.mapRows==c+1?f.ne.lat:f.sw.lat+i*(c+1),lng:e.mapRows==d+1?f.ne.lng:f.sw.lng+h*(d+1)}})},selectMarker:function(a,b){for(var c,d=this,e=d.levelShowen[d.zoom],f=0;f<b.length;f++)if(c=b[f],d.markerResidesArea(c,a)&&(e&&e.indexOf(c)>-1||!d.markerConflict(c,e)))return d.showMarker(c);return!1},markerResidesArea:function(a,b){return b.sw.lat<a.lat&&b.ne.lat>a.lat&&b.sw.lng<a.lng&&b.ne.lng>a.lng},markerConflict:function(b,c,d){if(!a.isArray(c)||0===c.length)return!1;for(var e,f=this,g=f.markerBounds(b),h=0;h<c.length;h++)if(b!=c[h]&&(e=f.markerBounds(c[h]),f.areaConflict(g,e)))return d&&console.log(b.toString()+" ? "+c[h].toString()),!0;return!1},markerBounds:function(c){var d=this,e=d.markerSize(c),f=e.height*d.markerSpace,g=e.width/2+f;return a.extend({},b.BOUNDS,{sw:{lat:c.lat-f,lng:c.lng-g},ne:{lat:c.lat+e.height+f,lng:c.lng+g}})},markerSize:function(a){var b,c=this,d=a&&a.icon&&(b=c.markerIcons[a.icon])&&{width:b.width,height:b.height}||{width:c.maxIconWidth,height:c.maxIconHeight};return{width:c.lngPixel*d.width,height:c.latPixel*d.height}},areaConflict:function(a,b){return b.sw.lat<=a.sw.lat&&b.ne.lat>=a.sw.lat&&b.sw.lng<=a.sw.lng&&b.ne.lng>=a.sw.lng||b.sw.lat<=a.sw.lat&&b.ne.lat>=a.sw.lat&&b.sw.lng<=a.ne.lng&&b.ne.lng>=a.ne.lng||b.sw.lat<=a.ne.lat&&b.ne.lat>=a.ne.lat&&b.sw.lng<=a.sw.lng&&b.ne.lng>=a.sw.lng||b.sw.lat<=a.ne.lat&&b.ne.lat>=a.ne.lat&&b.sw.lng<=a.ne.lng&&b.ne.lng>=a.ne.lng},showMarker:function(a){var b=this;if(!(a&&a.lat&&a.lng&&a.icon&&-1!=b.allMarkers.indexOf(a)))return console.log("Bad marker:"),console.log(a),!1;var c=a.toString(),d=b.map.allMarkers;d[c]||(d[c]=b.map.getMarker(a),b.map.mapMarkers.push(d[c])),-1==b.showenMarkers.indexOf(a)&&b.showenMarkers.push(a),-1==b.currentMarkers.indexOf(a)&&b.currentMarkers.push(a),-1==b.levelShowen[b.zoom].indexOf(a)&&b.levelShowen[b.zoom].push(a);var e;return(e=b.hiddenMarkers.indexOf(a))>-1&&b.hiddenMarkers.splice(e,1),!0},hideMarker:function(a){var b=this;if(!(a&&a.lat&&a.lng&&a.icon&&-1!=b.allMarkers.indexOf(a)))return!1;var c,d=a.toString(),e=b.map.allMarkers,f=b.map.mapMarkers;return e[d]&&(b.map.hideMarker(e[d]),c=f.indexOf(e[d]),b.map.freeMarkers.push(f.splice(c,1).shift()),e[d]=!1),(c=b.currentMarkers.indexOf(a))>-1&&b.currentMarkers.splice(c,1),!0},areaDiscovered:function(a){for(var b=this,c=0;c<b.discoveredAreas.length;c++)if(b.areaResidesArea(a,b.discoveredAreas[c]))return!0;return!1},areaResidesArea:function(a,b){return b.sw.lat<=a.sw.lat&&b.ne.lat>=a.ne.lat&&a.ne.lat>=a.sw.lat&&b.sw.lng<=a.sw.lng&&b.ne.lng>=a.ne.lng&&a.ne.lng>=a.sw.lng},saveArea:function(a){for(var b,c=this,d=0;d<c.discoveredAreas.length;d++)b=c.discoveredAreas[d],c.areaResidesArea(b,a)&&c.discoveredAreas.splice(d,1)&&d--;c.discoveredAreas.push(a)},loadMarkers:function(){var b,c=this,d=a.Deferred(),e=c.markersFeed,f=c.map.getBounds(),g=f.toString();return null==e||c.areaDiscovered(f)?(d.resolve(),d.promise()):(e.indexOf("$bounds")>-1&&(b=e.replace("$bounds",g))||(b=e+g),c.loadMarkersUrl(b).done(function(){c.saveArea(f),d.resolve()}),d.promise())},loadMarkersUrl:function(b){var c=this,d=a.Deferred();return a.get(b,function(a){c.saveMarkers(a).done(function(){c.calculateColsRows(),d.resolve()})}).fail(function(){d.resolve()}),d.promise()},saveMarkers:function(c){for(var d,e,f=this,g=a.Deferred(),h=0,i=f.options["marker-icon"],j=!1,k=0,l=function(){h++,j&&k==h&&g.resolve()},m=function(){f.icon=i,l()};k<c.length;k++)d=a.extend({},b.MARKER,{lat:c[k][0],lng:c[k][1],icon:c[k][2]?c[k][2]:i}),e=d.toString(),null==f.markerReference[e]&&(f.loadIcon(d.icon).done(l).fail(a.proxy(m,d)),f.markerReference[e]=d,f.allMarkers.push(d),f.hiddenMarkers.push(d));return j=!0,g.promise()},syncMarkers:function(){var a,b,c,d,e=this,f=e.map.mapMarkers,g=e.map.allMarkers,h=e.currentMarkers,i=[];for(d=0;d<h.length;d++)a=h[d],b=a.toString(),c=g[b],c&&f.indexOf(c)>-1&&i.push(c);for(d=0;d<f.length;d++)-1==i.indexOf(f[d])&&(e.map.hideMarker(f[d]),e.map.freeMarkers.push(f.splice(d,1).shift()),d--);for(b in g)-1==f.indexOf(g[b])&&(g[b]=!1);e.refresh()}};a.mapsManager.makePlugin("mapsmanager",c,b)}(jQuery);
//# sourceMappingURL=mapsmanager.min.js.map